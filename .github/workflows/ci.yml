# CI Pipeline â€” auraxis-app
# Stack: React Native Â· Expo SDK 54 Â· TypeScript strict Â· Jest Â· Detox (scaffold)
# Executa em todo PR e push para master.
#
# Secrets necessÃ¡rios (Settings â†’ Secrets and variables â†’ Actions):
#   EXPO_TOKEN    â€” Expo account token (expo.dev â†’ Account Settings â†’ Access Tokens)
#   SONAR_AURAXIS_APP_TOKEN â€” SonarCloud (sonarcloud.io â†’ My Account â†’ Security)
#
# Nota sobre Detox / EAS Build nativo:
#   Builds iOS/Android nativos requerem macOS runner (custo) ou self-hosted.
#   Este pipeline verifica apenas o bundle JS + testes unitÃ¡rios.
#   E2E com Detox deve rodar em self-hosted runner com macOS.

name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  NODE_VERSION: '22'

jobs:
  # â”€â”€ 1. Lint (ESLint) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - run: npm run lint -- --max-warnings 0

  # â”€â”€ 2. Type-check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  typecheck:
    name: TypeScript (strict)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - run: npm run typecheck

  # â”€â”€ 3. Hygiene de Feature Flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  feature-flag-hygiene:
    name: Feature Flags Hygiene
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Validate feature flags metadata
        run: node scripts/check-feature-flags.cjs

  # â”€â”€ 4. Frontend Governance Guardrails â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend-governance:
    name: Frontend Governance
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - run: npm run policy:check

  # â”€â”€ 4. Testes com coverage (Jest) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Tests + Coverage (Jest)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - name: Run tests with coverage
        run: npm run test:coverage
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

  # â”€â”€ 4.1 Contract Smoke (OpenAPI + Feature Contract Packs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  contract-smoke:
    name: Contract Smoke (OpenAPI + Packs)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - name: Validate generated OpenAPI types and contract pack baseline
        run: npm run contracts:check

  # â”€â”€ 5. Expo JS Bundle Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Verifica que o bundle JS compila sem erros (nÃ£o requer macOS).
  expo-bundle:
    name: Expo JS Bundle Check
    runs-on: ubuntu-latest
    needs: [lint, typecheck, feature-flag-hygiene, frontend-governance, test, contract-smoke]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Export JS bundle (Android + iOS)
        run: npx expo export --platform all --output-dir dist
        continue-on-error: false
      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: expo-bundle-all
          path: dist/
          retention-days: 1

  # â”€â”€ 6. Bundle Size Analysis (Metro) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bundle-analysis:
    name: Bundle Size Analysis (Metro)
    runs-on: ubuntu-latest
    needs: [expo-bundle]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Download bundle artifact from previous job
        uses: actions/download-artifact@v4
        with:
          name: expo-bundle-all
          path: dist
      - name: Report bundle sizes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            function getDirSize(dirPath) {
              if (!fs.existsSync(dirPath)) return 0;
              let total = 0;
              const entries = fs.readdirSync(dirPath, { withFileTypes: true });
              for (const entry of entries) {
                const full = path.join(dirPath, entry.name);
                if (entry.isDirectory()) total += getDirSize(full);
                else total += fs.statSync(full).size;
              }
              return total;
            }

            const fmt = (b) => b === 0 ? 'N/A' : (b / 1024).toFixed(1) + ' KB';
            const android = getDirSize('dist/_expo/static/js/android');
            const ios = getDirSize('dist/_expo/static/js/ios');

            const body = [
              '## ðŸ“¦ Bundle Size Report (Metro)',
              '',
              '| Platform | Bundle Size |',
              '|:---------|------------:|',
              `| Android | ${fmt(android)} |`,
              `| iOS | ${fmt(ios)} |`,
              '',
              '> Thresholds: â‰¤ 3 MB (aviso) Â· â‰¤ 6 MB (hard limit por plataforma)',
            ].join('\n');

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            } catch (error) {
              core.warning(`Could not post bundle report comment: ${error.message}`);
            }

            const limit = 6 * 1024 * 1024;
            if (android > limit) core.setFailed(`Android bundle too large: ${fmt(android)}`);
            if (ios > limit) core.setFailed(`iOS bundle too large: ${fmt(ios)}`);

  # â”€â”€ 6. Secret Scan (Gitleaks) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secret-scan-gitleaks:
    name: Secret Scan (Gitleaks)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€ 7. Secret Scan (TruffleHog) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secret-scan-trufflehog:
    name: Secret Scan (TruffleHog)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install TruffleHog binary (retry)
        run: |
          set -euo pipefail
          version="v3.90.5"
          archive="trufflehog_${version#v}_linux_amd64.tar.gz"
          url="https://github.com/trufflesecurity/trufflehog/releases/download/${version}/${archive}"

          for attempt in 1 2 3; do
            echo "Download attempt ${attempt}..."
            if curl -fsSL --connect-timeout 20 --max-time 120 "$url" -o "/tmp/${archive}"; then
              break
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "Failed to download TruffleHog after retries." >&2
              exit 1
            fi
            sleep $((attempt * 5))
          done

          tar -xzf "/tmp/${archive}" -C /tmp
          sudo mv /tmp/trufflehog /usr/local/bin/trufflehog
          trufflehog --version

      - name: Run TruffleHog
        run: trufflehog filesystem . --only-verified --fail

  # â”€â”€ 8. Dependency Audit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  audit:
    name: Dependency Audit (npm)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - name: Audit runtime deps (high/critical) with temporary Expo allowlist
        run: node scripts/ci-audit-gate.js

  # â”€â”€ 9. SonarCloud â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Modelo oficial: CI-based analysis (Automatic Analysis desabilitado no SonarCloud).
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [test]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - name: Generate coverage for Sonar
        run: npm run test:coverage
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_AURAXIS_APP_TOKEN }}

  # â”€â”€ 10. Commit lint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  commitlint:
    name: Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  # â”€â”€ 11. Detox E2E (scaffold â€” self-hosted macOS runner) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Este job estÃ¡ comentado por padrÃ£o.
  # Para habilitar: descomentar + configurar self-hosted runner com macOS + Xcode.
  # detox-e2e:
  #   name: Detox E2E (iOS)
  #   runs-on: [self-hosted, macOS, detox]
  #   needs: [lint, typecheck, test]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: npm
  #     - run: npm ci --ignore-scripts
  #     - name: Setup Detox
  #       run: npm run detox:build:ios
  #     - name: Run Detox tests
  #       run: npm run detox:test:ios
  #     - name: Upload Detox artifacts
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: detox-artifacts
  #         path: artifacts/
